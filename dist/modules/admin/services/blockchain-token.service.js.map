{"version":3,"sources":["../../../../src/modules/admin/services/blockchain-token.service.ts"],"sourcesContent":["import { Inject, Injectable, Logger, NotFoundException, OnModuleInit } from \"@nestjs/common\";\r\nimport ganache, { EthereumProvider, ServerOptions } from \"ganache\";\r\nimport contractOutputConfig from \"src/config/blockchain/contract-output.config\";\r\nimport AppConfig from \"src/modules/shared/app.config\";\r\nimport Web3, { Contract } from \"web3\";\r\nimport WalletCreatedDTO from \"../dtos/wallet-created.dto\";\r\nimport { BLOCKCHAIN_REPOSITORY_TOKEN, IBlockchainTokenRepository } from \"../interfaces/blockchain-token-repository.interface\";\r\nimport { IBlockchainTokenService } from \"../interfaces/blockchain-token-service.interface\";\r\nimport { BlockchainToken } from \"../schemas/blockchain-token.schema\";\r\nimport { Connection } from \"mongoose\";\r\nimport { InjectConnection } from \"@nestjs/mongoose\";\r\n\r\n@Injectable()\r\nexport default class BlockchainTokenService implements OnModuleInit, IBlockchainTokenService {\r\n    \r\n    static readonly INITIAL_SUPPLY = 1000000000000000000000000n;\r\n    static readonly GAS = '6721975';\r\n    static readonly GAS_PRICE = '875000000';\r\n    static readonly TOTAL_ACCOUNTS = 1;\r\n    static readonly TOTAL_TOKEN_TO_SEND = 10n;\r\n\r\n    readonly logger = new Logger(BlockchainTokenService.name);\r\n \r\n    private _web3: Web3;\r\n\r\n    private tokenContract: Contract<any>;\r\n\r\n    get web3() {\r\n        return this._web3;\r\n    }\r\n\r\n    constructor(\r\n        @Inject(BLOCKCHAIN_REPOSITORY_TOKEN)\r\n        private readonly _blockchainTokenRepository: IBlockchainTokenRepository,\r\n        private readonly _appConfig: AppConfig,\r\n        @InjectConnection()\r\n        private readonly _connection: Connection\r\n    ) {}\r\n\r\n    async transferReward(toAddress: string): Promise<boolean> {\r\n        try {\r\n            const { accountAddress } = await this._blockchainTokenRepository.findFirst();\r\n\r\n            await this.tokenContract.methods.transfer(toAddress, BlockchainTokenService.TOTAL_TOKEN_TO_SEND)\r\n                .send({\r\n                    from: accountAddress,\r\n                });\r\n                \r\n            return true;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    async transferEther(toAddress: string): Promise<boolean> {\r\n        try {\r\n            const { accountAddress, privateKey } = await this._blockchainTokenRepository.findFirst();\r\n            const amountInWei = this._web3.utils.toWei(1000, 'ether');\r\n            const tx = {\r\n                from: accountAddress,\r\n                to: toAddress,\r\n                value: amountInWei,\r\n                gas: BlockchainTokenService.GAS,\r\n                gasPrice: BlockchainTokenService.GAS_PRICE,\r\n            };\r\n\r\n            const signed = await this._web3.eth.accounts.signTransaction(tx, privateKey);\r\n            await this._web3.eth.sendSignedTransaction(signed.rawTransaction);\r\n            return true;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n\r\n    async registerVote(address: string, publicConsultationId: string): Promise<boolean> {\r\n       try {\r\n            await this.tokenContract.methods.castVote(publicConsultationId)\r\n                .send({ from: address });\r\n            return true;\r\n       } catch(error) {\r\n            return false;\r\n       }\r\n    }\r\n\r\n\r\n    async findBalanceByAccountAddress(accountAddress: string): Promise<bigint> {\r\n       try {\r\n         return await this.tokenContract.methods.balanceOf(accountAddress).call();\r\n       } catch(error) {\r\n         return 0n;\r\n       }\r\n    }\r\n\r\n    async createAccount(): Promise<WalletCreatedDTO> {\r\n        if (!this._web3) {\r\n            throw new NotFoundException('Web3 is not configured.');\r\n        }\r\n        const account = this._web3.eth.accounts.create();\r\n        const { tokenAddress } = await this._blockchainTokenRepository.findFirst();\r\n        \r\n        return new WalletCreatedDTO({\r\n            accountAddress: account.address,\r\n            privateKey: account.privateKey,\r\n            tokenAddress\r\n        });\r\n    }\r\n\r\n    async onModuleInit() {\r\n        try {\r\n            await this._connection.dropDatabase();\r\n            const SERVER_PORT = parseInt(this._appConfig.blockchainServerPORT);\r\n            const options: ServerOptions = {\r\n                wallet: {\r\n                    defaultBalance: Number.MAX_SAFE_INTEGER,\r\n                    totalAccounts: BlockchainTokenService.TOTAL_ACCOUNTS,\r\n                },\r\n            };\r\n            const server = ganache.server(options);\r\n            \r\n            server.listen(SERVER_PORT, async err => {\r\n                if (err) throw err;\r\n                this.logger.log(`ganache listening on port ${SERVER_PORT}...`)\r\n                const provider = server.provider;\r\n                await this.startWeb3(provider);\r\n            });\r\n\r\n        } catch (error) {\r\n            console.log(error);\r\n        }\r\n    }\r\n\r\n    async startWeb3(provider: EthereumProvider) {\r\n        this._web3 = new Web3(provider);\r\n        const { abi, evm } = contractOutputConfig as any;\r\n        \r\n        await this._blockchainTokenRepository.deleteAll();\r\n    \r\n        let accounts: string[] = [];\r\n        accounts = await this._web3.eth.getAccounts();\r\n\r\n        if (!accounts.length) {\r\n            this.logger.warn('Não há nenhuma conta padrão cadastrada.');\r\n            return;\r\n        }\r\n\r\n        const account = accounts[0];\r\n        const accountInfo = provider.getInitialAccounts()[account.toLowerCase()];\r\n        const result = await new this._web3.eth.Contract(abi)\r\n\r\n        .deploy({ data: evm.bytecode.object, arguments: [BlockchainTokenService.INITIAL_SUPPLY] })\r\n        .send({\r\n            from: account,\r\n            gas: BlockchainTokenService.GAS,\r\n            gasPrice: BlockchainTokenService.GAS_PRICE,\r\n        });\r\n\r\n        const blockchainToken = new BlockchainToken({\r\n            tokenAddress: result.options.address,\r\n            accountAddress: account,\r\n            privateKey: accountInfo.secretKey,\r\n        });\r\n\r\n        await this._blockchainTokenRepository.create(blockchainToken);\r\n\r\n        this.tokenContract = new this._web3.eth.Contract(abi, blockchainToken.tokenAddress);\r\n    }\r\n \r\n    async checkToken(abi: any, tokenAddress: string) {\r\n        try {\r\n            const tokenContract = new this._web3.eth.Contract(abi, tokenAddress);\r\n            await Promise.all([tokenContract.methods.name().call(),  tokenContract.methods.symbol().call()]);\r\n            return true;\r\n        } catch (error) {\r\n            return false;\r\n        }\r\n    }\r\n\r\n\r\n}"],"names":["BlockchainTokenService","web3","_web3","transferReward","toAddress","accountAddress","_blockchainTokenRepository","findFirst","tokenContract","methods","transfer","TOTAL_TOKEN_TO_SEND","send","from","transferEther","privateKey","amountInWei","utils","toWei","tx","to","value","gas","GAS","gasPrice","GAS_PRICE","signed","eth","accounts","signTransaction","sendSignedTransaction","rawTransaction","registerVote","address","publicConsultationId","castVote","error","findBalanceByAccountAddress","balanceOf","call","createAccount","NotFoundException","account","create","tokenAddress","WalletCreatedDTO","onModuleInit","_connection","dropDatabase","SERVER_PORT","parseInt","_appConfig","blockchainServerPORT","options","wallet","defaultBalance","Number","MAX_SAFE_INTEGER","totalAccounts","TOTAL_ACCOUNTS","server","ganache","listen","err","logger","log","provider","startWeb3","console","Web3","abi","evm","contractOutputConfig","deleteAll","getAccounts","length","warn","accountInfo","getInitialAccounts","toLowerCase","result","Contract","deploy","data","bytecode","object","arguments","INITIAL_SUPPLY","blockchainToken","BlockchainToken","secretKey","checkToken","Promise","all","name","symbol","constructor","Logger"],"mappings":"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"}