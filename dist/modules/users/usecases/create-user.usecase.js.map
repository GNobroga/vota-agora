{"version":3,"sources":["../../../../src/modules/users/usecases/create-user.usecase.ts"],"sourcesContent":["import { ConflictException, Inject, Injectable } from \"@nestjs/common\";\r\nimport IDefaultUseCase from \"src/core/usecases/default.usecase\";\r\nimport { IUserRepository, USER_REPOSITORY_TOKEN } from \"../user.repository\";\r\nimport { User } from \"../user.schema\";\r\nimport { BLOCKCHAIN_SERVICE_TOKEN, IBlockchainTokenService } from \"src/modules/admin/services/blockchain-token.service\";\r\nimport UserWithAccountTokenResponseDTO from \"../dtos/response/user-with-account-token-response.dto\";\r\n\r\n@Injectable()\r\nexport default class CreateUserUseCase implements IDefaultUseCase<User, UserWithAccountTokenResponseDTO> {\r\n    \r\n    constructor(\r\n        @Inject(USER_REPOSITORY_TOKEN)\r\n        private readonly _userRepository: IUserRepository,\r\n        @Inject(BLOCKCHAIN_SERVICE_TOKEN)\r\n        private readonly _blockchainTokenService: IBlockchainTokenService\r\n    ) {}\r\n    \r\n    async execute(input: User): Promise<UserWithAccountTokenResponseDTO> {\r\n        input.document = input.document.replace(/\\D/g, '');\r\n\r\n        if ((await this._userRepository.findByDocument(input.document)) != null) {\r\n            throw new ConflictException(\"O documento não está disponível.\");\r\n        }\r\n\r\n        const { tokenAddress, accountAddress, privateKey } = await this._blockchainTokenService.createAccount();\r\n        input.accountAddress = accountAddress;\r\n        input.privateKey = privateKey;\r\n   \r\n        input = await this._userRepository.create(input);\r\n\r\n        const response = new UserWithAccountTokenResponseDTO({\r\n            id: input['_id'],\r\n            fullName: input.fullName,\r\n            document: input.document,\r\n            tokenAddress,\r\n            accessKey: privateKey,\r\n        })\r\n        return response;\r\n    }\r\n\r\n}"],"names":["CreateUserUseCase","execute","input","document","replace","_userRepository","findByDocument","ConflictException","tokenAddress","accountAddress","privateKey","_blockchainTokenService","createAccount","create","response","UserWithAccountTokenResponseDTO","id","fullName","accessKey","constructor"],"mappings":";;;;;;;eAQqBA;;;wBARiC;gCAEC;wCAEW;wFACtB;;;;;;;;;;;;;;;;;;;;AAG7B,IAAA,AAAMA,oBAAN,MAAMA;IASjB,MAAMC,QAAQC,KAAW,EAA4C;QACjEA,MAAMC,QAAQ,GAAGD,MAAMC,QAAQ,CAACC,OAAO,CAAC,OAAO;QAE/C,IAAI,AAAC,MAAM,IAAI,CAACC,eAAe,CAACC,cAAc,CAACJ,MAAMC,QAAQ,KAAM,MAAM;YACrE,MAAM,IAAII,yBAAiB,CAAC;QAChC;QAEA,MAAM,EAAEC,YAAY,EAAEC,cAAc,EAAEC,UAAU,EAAE,GAAG,MAAM,IAAI,CAACC,uBAAuB,CAACC,aAAa;QACrGV,MAAMO,cAAc,GAAGA;QACvBP,MAAMQ,UAAU,GAAGA;QAEnBR,QAAQ,MAAM,IAAI,CAACG,eAAe,CAACQ,MAAM,CAACX;QAE1C,MAAMY,WAAW,IAAIC,wCAA+B,CAAC;YACjDC,IAAId,KAAK,CAAC,MAAM;YAChBe,UAAUf,MAAMe,QAAQ;YACxBd,UAAUD,MAAMC,QAAQ;YACxBK;YACAU,WAAWR;QACf;QACA,OAAOI;IACX;IA5BAK,YACI,AACiBd,eAAgC,EACjD,AACiBM,uBAAgD,CACnE;aAHmBN,kBAAAA;aAEAM,0BAAAA;IAClB;AAyBP"}