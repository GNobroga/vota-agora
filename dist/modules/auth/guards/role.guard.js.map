{"version":3,"sources":["../../../../src/modules/auth/guards/role.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, Injectable } from \"@nestjs/common\";\r\nimport { Reflector } from \"@nestjs/core\";\r\nimport { Observable } from \"rxjs\";\r\nimport { ALLOW_ROLES_KEY } from \"../decorators/allow-roles.decorator\";\r\n\r\n@Injectable()\r\nexport default class RoleGuard implements CanActivate {\r\n\r\n    constructor(private readonly reflector: Reflector) {}\r\n\r\n    canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {\r\n        const request = context.switchToHttp().getRequest<Request>();\r\n        const claimRoles: string[] =  request['user']?.role ?? [];\r\n        const classRoles = this.reflector.get<string[]>(ALLOW_ROLES_KEY, context.getClass()) ?? [];\r\n        const handlerRoles = this.reflector.get<string[]>(ALLOW_ROLES_KEY, context.getHandler()) ?? [];\r\n        \r\n        const roles = [] as string[];\r\n        \r\n        if (!handlerRoles.length) {\r\n            roles.push(...classRoles);\r\n        } else {\r\n            roles.push(...handlerRoles);\r\n        }\r\n\r\n        return roles.some(role => claimRoles.includes(role));\r\n    }\r\n    \r\n}"],"names":["RoleGuard","canActivate","context","request","switchToHttp","getRequest","claimRoles","role","classRoles","reflector","get","ALLOW_ROLES_KEY","getClass","handlerRoles","getHandler","roles","length","push","some","includes","constructor"],"mappings":";;;;;;;eAMqBA;;;wBANqC;sBAChC;qCAEM;;;;;;;;;;AAGjB,IAAA,AAAMA,YAAN,MAAMA;IAIjBC,YAAYC,OAAyB,EAAoD;QACrF,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAMC,aAAwBH,OAAO,CAAC,OAAO,EAAEI,QAAQ,EAAE;QACzD,MAAMC,aAAa,IAAI,CAACC,SAAS,CAACC,GAAG,CAAWC,oCAAe,EAAET,QAAQU,QAAQ,OAAO,EAAE;QAC1F,MAAMC,eAAe,IAAI,CAACJ,SAAS,CAACC,GAAG,CAAWC,oCAAe,EAAET,QAAQY,UAAU,OAAO,EAAE;QAE9F,MAAMC,QAAQ,EAAE;QAEhB,IAAI,CAACF,aAAaG,MAAM,EAAE;YACtBD,MAAME,IAAI,IAAIT;QAClB,OAAO;YACHO,MAAME,IAAI,IAAIJ;QAClB;QAEA,OAAOE,MAAMG,IAAI,CAACX,CAAAA,OAAQD,WAAWa,QAAQ,CAACZ;IAClD;IAjBAa,YAAY,AAAiBX,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AAmBxD"}